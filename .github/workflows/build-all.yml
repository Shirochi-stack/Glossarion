name: Build All Platforms

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  # ============================================================================
  # Windows Lite Build
  # ============================================================================
  build-windows-lite:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install MSYS2 for WeasyPrint
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          location: C:\msys64
          update: true
          install: >-
            mingw-w64-x86_64-gtk3
            mingw-w64-x86_64-pango
            mingw-w64-x86_64-cairo
            mingw-w64-x86_64-gdk-pixbuf2
            mingw-w64-x86_64-libffi
            mingw-w64-x86_64-glib2
            mingw-w64-x86_64-harfbuzz
            mingw-w64-x86_64-fribidi
            mingw-w64-x86_64-fontconfig
            mingw-w64-x86_64-freetype
      
      - name: Add MSYS2 to PATH
        shell: pwsh
        run: |
          echo "C:\msys64\mingw64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "GTK_FOLDER=C:\msys64\mingw64" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          # Verify DLLs exist
          if (Test-Path "C:\msys64\mingw64\bin\libpango-1.0-0.dll") { echo "Pango DLL found" } else { echo "WARNING: Pango DLL not found" }
      
      - name: Install dependencies
        shell: pwsh
        run: |
          $env:PATH = "C:\msys64\mingw64\bin;" + $env:PATH
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements.txt
      
      - name: Build with PyInstaller
        shell: pwsh
        run: |
          $env:PATH = "C:\msys64\mingw64\bin;" + $env:PATH
          $env:GTK_FOLDER = "C:\msys64\mingw64"
          cd src
          pyinstaller translator_lite.spec
      
      - name: Upload Windows Lite artifact
        uses: actions/upload-artifact@v4
        with:
          name: Glossarion-Lite-Windows
          path: src/dist/*.exe
          if-no-files-found: error

  # ============================================================================
  # Windows NoCuda Build
  # ============================================================================
  build-windows-nocuda:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install MSYS2 for WeasyPrint
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          location: C:\msys64
          update: true
          install: >-
            mingw-w64-x86_64-gtk3
            mingw-w64-x86_64-pango
            mingw-w64-x86_64-cairo
            mingw-w64-x86_64-gdk-pixbuf2
            mingw-w64-x86_64-libffi
            mingw-w64-x86_64-glib2
            mingw-w64-x86_64-harfbuzz
            mingw-w64-x86_64-fribidi
            mingw-w64-x86_64-fontconfig
            mingw-w64-x86_64-freetype
      
      - name: Add MSYS2 to PATH
        shell: pwsh
        run: |
          echo "C:\msys64\mingw64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "GTK_FOLDER=C:\msys64\mingw64" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          # Verify DLLs exist
          if (Test-Path "C:\msys64\mingw64\bin\libpango-1.0-0.dll") { echo "Pango DLL found" } else { echo "WARNING: Pango DLL not found" }
      
      - name: Install dependencies
        shell: pwsh
        run: |
          $env:PATH = "C:\msys64\mingw64\bin;" + $env:PATH
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements.txt
      
      - name: Build with PyInstaller
        shell: pwsh
        run: |
          $env:PATH = "C:\msys64\mingw64\bin;" + $env:PATH
          $env:GTK_FOLDER = "C:\msys64\mingw64"
          cd src
          pyinstaller translator_NoCuda.spec
      
      - name: Upload Windows NoCuda artifact
        uses: actions/upload-artifact@v4
        with:
          name: Glossarion-NoCuda-Windows
          path: src/dist/*.exe
          if-no-files-found: error

  # ============================================================================
  # macOS Build
  # ============================================================================
  build-macos:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install system dependencies
        run: |
          brew install create-dmg
          brew install pango cairo libffi gdk-pixbuf gobject-introspection
          brew install pkg-config cmake
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements-macos.txt
      
      - name: Build with PyInstaller
        run: pyinstaller translator_lite_mac.spec
        working-directory: src
      
      - name: Upload macOS DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: Glossarion-Lite-macOS
          path: src/dist/*.dmg
          if-no-files-found: warn
      
      - name: Upload macOS app artifact (fallback)
        uses: actions/upload-artifact@v4
        with:
          name: Glossarion-Lite-macOS-App
          path: src/dist/*.app
          if-no-files-found: warn

  # ============================================================================
  # Linux Build
  # ============================================================================
  build-linux:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libpango-1.0-0 \
            libpango1.0-dev \
            libpangocairo-1.0-0 \
            libcairo2 \
            libcairo2-dev \
            libgdk-pixbuf2.0-0 \
            libgdk-pixbuf2.0-dev \
            libffi-dev \
            pkg-config \
            cmake \
            libgirepository1.0-dev \
            gir1.2-pango-1.0 \
            python3-dev \
            build-essential
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements-macos.txt
      
      - name: Build with PyInstaller
        run: pyinstaller translator_lite_linux.spec
        working-directory: src
      
      - name: Make executable
        run: chmod +x src/dist/Glossarion_Lite_v7.5.2
      
      - name: Create tarball
        run: |
          cd src/dist
          tar -czvf Glossarion-Lite-Linux.tar.gz Glossarion_Lite_v7.5.2
      
      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: Glossarion-Lite-Linux
          path: src/dist/Glossarion-Lite-Linux.tar.gz
          if-no-files-found: error
