name: Build All Platforms

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  # ============================================================================
  # Windows Lite Build
  # ============================================================================
  build-windows-lite:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install MSYS2 for WeasyPrint
        uses: msys2/setup-msys2@v2
        id: msys2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gtk3
            mingw-w64-x86_64-pango
            mingw-w64-x86_64-cairo
            mingw-w64-x86_64-gdk-pixbuf2
            mingw-w64-x86_64-libffi
            mingw-w64-x86_64-glib2
            mingw-w64-x86_64-harfbuzz
            mingw-w64-x86_64-fribidi
            mingw-w64-x86_64-fontconfig
            mingw-w64-x86_64-freetype
      
      - name: Find and set MSYS2 paths
        shell: pwsh
        run: |
          # Find MSYS2 installation
          $msysRoot = "${{ steps.msys2.outputs.msys2-location }}"
          if (-not $msysRoot) {
            # Fallback: search common locations
            $possiblePaths = @("D:\a\_temp\msys64", "C:\msys64", "$env:RUNNER_TEMP\msys64")
            foreach ($p in $possiblePaths) {
              if (Test-Path "$p\mingw64\bin") {
                $msysRoot = $p
                break
              }
            }
          }
          echo "MSYS2 root: $msysRoot"
          echo "MSYS2_ROOT=$msysRoot" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "$msysRoot\mingw64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "GTK_FOLDER=$msysRoot\mingw64" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      
      - name: Verify MSYS2 DLLs
        shell: pwsh
        run: |
          echo "=== Checking MSYS2 installation ==="
          echo "MSYS2_ROOT=$env:MSYS2_ROOT"
          echo "GTK_FOLDER=$env:GTK_FOLDER"
          $binPath = "$env:MSYS2_ROOT\mingw64\bin"
          if (Test-Path $binPath) {
            echo "MSYS2 bin directory exists at $binPath"
            $dlls = Get-ChildItem "$binPath\*.dll" -ErrorAction SilentlyContinue | Measure-Object
            echo "Found $($dlls.Count) DLLs in MSYS2 bin"
            # Check for key WeasyPrint dependencies
            $keyDlls = @('libpango-1.0-0.dll', 'libcairo-2.dll', 'libgobject-2.0-0.dll', 'libglib-2.0-0.dll', 'libharfbuzz-0.dll', 'libfontconfig-1.dll')
            foreach ($dll in $keyDlls) {
              if (Test-Path "$binPath\$dll") { echo "  OK: $dll" } else { echo "  MISSING: $dll" }
            }
          } else {
            echo "ERROR: MSYS2 bin directory not found at $binPath!"
            # List what directories exist
            echo "Searching for MSYS2..."
            Get-ChildItem -Path "D:\a\_temp" -Directory -ErrorAction SilentlyContinue | ForEach-Object { echo $_.FullName }
            exit 1
          }
      
      - name: Install dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements.txt
      
      - name: Build with PyInstaller
        shell: pwsh
        run: |
          cd src
          pyinstaller translator_lite.spec
      
      - name: Upload Windows Lite artifact
        uses: actions/upload-artifact@v4
        with:
          name: Glossarion-Lite-Windows
          path: src/dist/*.exe
          if-no-files-found: error

  # ============================================================================
  # Windows NoCuda Build
  # ============================================================================
  build-windows-nocuda:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install MSYS2 for WeasyPrint
        uses: msys2/setup-msys2@v2
        id: msys2-nocuda
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gtk3
            mingw-w64-x86_64-pango
            mingw-w64-x86_64-cairo
            mingw-w64-x86_64-gdk-pixbuf2
            mingw-w64-x86_64-libffi
            mingw-w64-x86_64-glib2
            mingw-w64-x86_64-harfbuzz
            mingw-w64-x86_64-fribidi
            mingw-w64-x86_64-fontconfig
            mingw-w64-x86_64-freetype
      
      - name: Find and set MSYS2 paths
        shell: pwsh
        run: |
          # Find MSYS2 installation
          $msysRoot = "${{ steps.msys2-nocuda.outputs.msys2-location }}"
          if (-not $msysRoot) {
            # Fallback: search common locations
            $possiblePaths = @("D:\a\_temp\msys64", "C:\msys64", "$env:RUNNER_TEMP\msys64")
            foreach ($p in $possiblePaths) {
              if (Test-Path "$p\mingw64\bin") {
                $msysRoot = $p
                break
              }
            }
          }
          echo "MSYS2 root: $msysRoot"
          echo "MSYS2_ROOT=$msysRoot" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "$msysRoot\mingw64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "GTK_FOLDER=$msysRoot\mingw64" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      
      - name: Verify MSYS2 DLLs
        shell: pwsh
        run: |
          echo "=== Checking MSYS2 installation ==="
          echo "MSYS2_ROOT=$env:MSYS2_ROOT"
          echo "GTK_FOLDER=$env:GTK_FOLDER"
          $binPath = "$env:MSYS2_ROOT\mingw64\bin"
          if (Test-Path $binPath) {
            echo "MSYS2 bin directory exists at $binPath"
            $dlls = Get-ChildItem "$binPath\*.dll" -ErrorAction SilentlyContinue | Measure-Object
            echo "Found $($dlls.Count) DLLs in MSYS2 bin"
            # Check for key WeasyPrint dependencies
            $keyDlls = @('libpango-1.0-0.dll', 'libcairo-2.dll', 'libgobject-2.0-0.dll', 'libglib-2.0-0.dll', 'libharfbuzz-0.dll', 'libfontconfig-1.dll')
            foreach ($dll in $keyDlls) {
              if (Test-Path "$binPath\$dll") { echo "  OK: $dll" } else { echo "  MISSING: $dll" }
            }
          } else {
            echo "ERROR: MSYS2 bin directory not found at $binPath!"
            # List what directories exist
            echo "Searching for MSYS2..."
            Get-ChildItem -Path "D:\a\_temp" -Directory -ErrorAction SilentlyContinue | ForEach-Object { echo $_.FullName }
            exit 1
          }
      
      - name: Install dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements.txt
      
      - name: Build with PyInstaller
        shell: pwsh
        run: |
          cd src
          pyinstaller translator_NoCuda.spec
      
      - name: Upload Windows NoCuda artifact
        uses: actions/upload-artifact@v4
        with:
          name: Glossarion-NoCuda-Windows
          path: src/dist/*.exe
          if-no-files-found: error

  # ============================================================================
  # macOS Build
  # ============================================================================
  build-macos:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install system dependencies
        run: |
          brew install create-dmg
          brew install pango cairo libffi gdk-pixbuf gobject-introspection
          brew install pkg-config cmake
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements-macos.txt
      
      - name: Build with PyInstaller
        run: pyinstaller translator_lite_mac.spec
        working-directory: src
      
      - name: Upload macOS DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: Glossarion-Lite-macOS
          path: src/dist/*.dmg
          if-no-files-found: warn
      
      - name: Upload macOS app artifact (fallback)
        uses: actions/upload-artifact@v4
        with:
          name: Glossarion-Lite-macOS-App
          path: src/dist/*.app
          if-no-files-found: warn

  # ============================================================================
  # Linux Build
  # ============================================================================
  build-linux:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libpango-1.0-0 \
            libpango1.0-dev \
            libpangocairo-1.0-0 \
            libcairo2 \
            libcairo2-dev \
            libgdk-pixbuf2.0-0 \
            libgdk-pixbuf2.0-dev \
            libffi-dev \
            pkg-config \
            cmake \
            libgirepository1.0-dev \
            gir1.2-pango-1.0 \
            python3-dev \
            build-essential
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements-macos.txt
      
      - name: Build with PyInstaller
        run: pyinstaller translator_lite_linux.spec
        working-directory: src
      
      - name: Make executable
        run: chmod +x src/dist/L_Glossarion_Lite_v7.6.3_Linux
      
      - name: Create tarball
        run: |
          cd src/dist
          tar -czvf Glossarion-Lite-Linux.tar.gz L_Glossarion_Lite_v7.6.3_Linux
      
      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: Glossarion-Lite-Linux
          path: src/dist/Glossarion-Lite-Linux.tar.gz
          if-no-files-found: error
